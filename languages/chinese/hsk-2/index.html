<!doctype html>
<html lang="en">
<head>
  <title>HSK 2.0 Vocabulary · Chinese · Memogatary</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/favicon.png" type="image/png" />
  <link rel="stylesheet" href="/assets/css/styles.css" />
  <script type="module" src="/assets/js/components/header.js"></script>
  <script type="module" src="/assets/js/components/footer.js"></script>
  <!-- Tailwind for PDF viewer -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #pdf-viewer canvas { max-width: 100%; height: auto; border: 1px solid #ddd; }
    #pdf-nav button:disabled { opacity: .5; cursor: not-allowed; }
  </style>
</head>
<body>
  <site-header></site-header>
  <main class="container prose">

    <h1>HSK 2.0 Vocabulary</h1>

    <!-- Viewer controls -->
    <div class="max-w-5xl mx-auto my-6">
      <label class="block text-sm text-slate-600 mb-1">Choose material</label>
      <select id="pdf-select" class="w-full border rounded p-2"></select>
      <p id="list-status" class="text-xs text-slate-500 mt-1"></p>
    </div>

    <!-- Jump to page -->
    <div class="flex gap-2 items-end my-4">
      <div>
        <label class="block text-sm text-slate-600 mb-1">Go to page</label>
        <input id="goto-input" type="number" min="1" class="border rounded p-2 w-28" />
      </div>
      <button id="goto-btn" class="h-10 px-4 rounded bg-indigo-600 text-white">Go</button>
    </div>

    <!-- PDF Viewer -->
    <section id="pdf-viewer" class="mt-4">
      <p id="loading-message" class="text-slate-600">Loading…</p>
      <div id="pdf-render-area" class="hidden justify-center items-start gap-4 p-2 bg-white rounded-t-lg shadow">
        <canvas id="pdf-canvas-1"></canvas>
        <canvas id="pdf-canvas-2"></canvas>
      </div>
      <div id="pdf-nav" class="hidden flex gap-3 justify-between items-center p-2 border-t bg-gray-50 rounded-b-lg">
        <div class="flex gap-2">
          <button id="prev-page" class="bg-gray-300 text-gray-900 font-semibold py-2 px-4 rounded">&lt; Previous</button>
          <button id="next-page" class="bg-gray-300 text-gray-900 font-semibold py-2 px-4 rounded">Next &gt;</button>
        </div>
        <span id="page-num-display" class="text-slate-700 font-medium"></span>
      </div>
    </section>

  </main>
  <site-footer></site-footer>

  <!-- PDF viewer script -->
  <script>
    /***** CONFIG — already filled in for HSK-2 *****/
    const APPS_SCRIPT_BASE = 'https://script.google.com/macros/s/AKfycbxI9QfAigtr23RlCPq_vxQsk7m0fzn6mTL8_DUTtFE8E60SmeeLcJUQCEGj_v6mMb6NTA/exec';
    const FOLDER_ID = '1fxVRg5zDlf-Zre6uy8ac48C3ILHtaPfF';

    /* Load PDF.js first, then init */
    (function loadPdfJs() {
      const s = document.createElement('script');
      s.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js';
      s.onload = initHSK;
      s.onerror = () => setStatus('Failed to load PDF.js');
      document.head.appendChild(s);
    })();

    /* ---- State & refs ---- */
    let pdfDoc = null;
    let currentPage = 1;
    let twoPageMode = true;            // auto: desktop = 2 pages, mobile = 1 page
    const cache = new Map();           // fileId -> base64 PDF

    const $ = (id) => document.getElementById(id);
    const canvas1 = () => $('pdf-canvas-1');
    const canvas2 = () => $('pdf-canvas-2');
    const ctx1    = () => canvas1().getContext('2d');
    const ctx2    = () => canvas2().getContext('2d');

    function setStatus(msg) { $('list-status')?.textContent = msg; }
    function setLoading(msg) { $('loading-message').textContent = msg; }

    /* ---- Utilities ---- */
    function base64ToUint8Array(base64) {
      const bin = atob(base64);
      const bytes = new Uint8Array(bin.length);
      for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
      return bytes;
    }

    function setModeFromViewport() {
      // <= 768px -> single page; otherwise two-page spread
      twoPageMode = !window.matchMedia('(max-width: 768px)').matches;
      canvas2().style.display = twoPageMode ? 'block' : 'none';
    }

    async function fetchList() {
      const url = `${APPS_SCRIPT_BASE}?mode=list&folderId=${encodeURIComponent(FOLDER_ID)}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('List fetch failed');
      const data = await res.json();
      if (data.error) throw new Error(data.error);
      return data; // [{id,name,display,modifiedTime}, ...]
    }

    function populateSelect(items) {
      const sel = $('pdf-select');
      sel.innerHTML = '';
      for (const it of items) {
        const opt = document.createElement('option');
        opt.value = it.id;
        opt.textContent = it.display || it.name.replace(/\.pdf$/i, '');
        sel.appendChild(opt);
      }
    }

    async function getPdfBase64(fileId) {
      if (cache.has(fileId)) return cache.get(fileId);
      const res = await fetch(`${APPS_SCRIPT_BASE}?mode=get&fileId=${encodeURIComponent(fileId)}`);
      if (!res.ok) throw new Error('PDF fetch failed');
      const b64 = await res.text();
      cache.set(fileId, b64);
      return b64;
    }

    async function loadAndOpen(fileId) {
      setLoading('Loading PDF...');
      const { pdfjsLib } = window;
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

      const b64 = await getPdfBase64(fileId);
      const data = base64ToUint8Array(b64);
      pdfDoc = await pdfjsLib.getDocument({ data }).promise;

      $('loading-message').style.display = 'none';
      $('pdf-render-area').style.display = 'flex';
      $('pdf-nav').style.display = 'flex';

      currentPage = 1;
      await renderPages(currentPage);
      updateNavButtons();
    }

    async function renderPages(startPage) {
      if (!pdfDoc) return;
      startPage = Math.max(1, Math.min(startPage, pdfDoc.numPages));

      const renderArea = $('pdf-render-area');
      const style = window.getComputedStyle(renderArea);
      const paddingX = parseFloat(style.paddingLeft) + parseFloat(style.paddingRight);
      const gap = parseFloat(style.gap) || 0;
      let availableWidth = renderArea.clientWidth - paddingX;

      const page1 = await pdfDoc.getPage(startPage);
      let totalPdfWidth = page1.getViewport({ scale: 1 }).width;

      let page2 = null;
      let page2Num = null;
      if (twoPageMode) {
        page2Num = startPage + 1;
        if (page2Num <= pdfDoc.numPages) {
          availableWidth -= gap;
          page2 = await pdfDoc.getPage(page2Num);
          totalPdfWidth += page2.getViewport({ scale: 1 }).width;
        }
      }

      const scale = availableWidth / totalPdfWidth;

      const vp1 = page1.getViewport({ scale });
      canvas1().width = vp1.width; canvas1().height = vp1.height;
      await page1.render({ canvasContext: ctx1(), viewport: vp1 }).promise;
      canvas1().style.display = 'block';

      if (twoPageMode && page2) {
        const vp2 = page2.getViewport({ scale });
        canvas2().width = vp2.width; canvas2().height = vp2.height;
        await page2.render({ canvasContext: ctx2(), viewport: vp2 }).promise;
        canvas2().style.display = 'block';
        $('page-num-display').textContent = `Pages ${startPage}–${page2Num} of ${pdfDoc.numPages}`;
      } else {
        canvas2().style.display = 'none';
        $('page-num-display').textContent = `Page ${startPage} of ${pdfDoc.numPages}`;
      }

      currentPage = startPage;
    }

    function updateNavButtons() {
      const prevDisabled = currentPage <= 1;
      const nextDisabled = twoPageMode
        ? (currentPage + 1 >= pdfDoc.numPages)
        : (currentPage >= pdfDoc.numPages);
      $('prev-page').disabled = prevDisabled;
      $('next-page').disabled = nextDisabled;
    }

    async function initHSK() {
      setModeFromViewport();
      window.addEventListener('resize', async () => {
        setModeFromViewport();
        if (pdfDoc) {
          if (twoPageMode && currentPage % 2 === 0) currentPage -= 1;
          await renderPages(currentPage);
          updateNavButtons();
        }
      });

      setStatus('Loading materials...');
      try {
        const list = await fetchList();
        if (!list.length) { setStatus('No PDFs found.'); return; }
        populateSelect(list);
        setStatus(`${list.length} materials found.`);
        $('pdf-select').addEventListener('change', (e) => loadAndOpen(e.target.value));
        await loadAndOpen(list[0].id);
      } catch (err) {
        setStatus(`Failed: ${err.message}`);
      }

      $('prev-page').addEventListener('click', async () => {
        const delta = twoPageMode ? 2 : 1;
        const target = currentPage - delta;
        if (target >= 1) {
          await renderPages(target);
          updateNavButtons();
        }
      });
      $('next-page').addEventListener('click', async () => {
        const delta = twoPageMode ? 2 : 1;
        const target = currentPage + delta;
        if (target <= pdfDoc.numPages) {
          await renderPages(target);
          updateNavButtons();
        }
      });

      $('goto-btn').addEventListener('click', async () => {
        if (!pdfDoc) return;
        const val = parseInt($('goto-input').value, 10);
        if (isNaN(val)) return;
        let target = Math.max(1, Math.min(val, pdfDoc.numPages));
        if (twoPageMode && target % 2 === 0) target -= 1;
        await renderPages(target);
        updateNavButtons();
      });
    }
  </script>
</body>
</html>
