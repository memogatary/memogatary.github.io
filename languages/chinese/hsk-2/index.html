<!doctype html>
<html lang="en">

<head>
    <title>HSK 2.0 Vocabulary · Chinese · Memogatary</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="/favicon.png" type="image/png" />
    <link rel="stylesheet" href="/assets/css/styles.css" />
    <script type="module" src="/assets/js/components/header.js"></script>
    <script type="module" src="/assets/js/components/footer.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Fixed-height viewer window with its own scrollbar */
        #viewer-viewport {
            height: 78vh;
            overflow: auto;
            border: 1px solid #e5e7eb;
            border-radius: .5rem;
            background: #fff;
        }

        /* Two-page spread row (never wrap) */
        #pdf-render-area {
            display: flex;
            flex-wrap: nowrap;
            align-items: flex-start;
            gap: 1rem;
            padding: .5rem;
            background: #fff;
            border-top-left-radius: .5rem;
            border-top-right-radius: .5rem;
        }

        /* Canvases are fixed-size flex items; render sharply */
        #pdf-render-area canvas {
            flex: 0 0 auto;
            display: block;
            max-width: none;
            height: auto;
            border: 1px solid #ddd;
            image-rendering: crisp-edges;
            image-rendering: -webkit-optimize-contrast;
        }

        /* Neutralize prose margins on canvas */
        .prose #pdf-render-area canvas {
            margin: 0 !important;
        }

        /* Footer nav */
        #pdf-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: .5rem;
            border-top: 1px solid #e5e7eb;
            background: #f9fafb;
            border-bottom-left-radius: .5rem;
            border-bottom-right-radius: .5rem;
        }

        #pdf-nav button:disabled {
            opacity: .5;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <site-header></site-header>

    <main class="container prose">
        <h1>HSK 2.0 Vocabulary</h1>

        <!-- Centered YouTube note -->
        <p class="text-center text-slate-700">
            Videos:
            <a class="text-indigo-600 underline" href="https://www.youtube.com/@LuyenTiengTrung" target="_blank"
                rel="noopener">Luyện Tiếng Trung</a>.
        </p>

        <!-- File picker -->
        <div class="max-w-5xl mx-auto my-6">
            <label class="block text-sm text-slate-600 mb-1">Choose material</label>
            <select id="pdf-select" class="w-full border rounded p-2"></select>
            <p id="list-status" class="text-xs text-slate-500 mt-1"></p>
        </div>

        <!-- Go to page -->
        <div id="goto-wrap" class="flex items-end gap-2 my-2">
            <div>
                <label class="block text-sm text-slate-600 mb-1">Go to page</label>
                <input id="goto-input" type="number" min="1" class="border rounded p-2 w-28" />
            </div>
            <button id="goto-btn" class="h-10 px-4 rounded bg-indigo-600 text-white">Go</button>
        </div>

        <!-- Viewer -->
        <section id="pdf-viewer" class="mt-2">
            <p id="loading-message" class="text-slate-600">Loading…</p>

            <!-- Spinner -->
            <div id="busy" class="hidden mt-3 flex items-center gap-2 text-slate-600">
                <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"
                        class="opacity-25"></circle>
                    <path d="M4 12a8 8 0 018-8" fill="currentColor" class="opacity-75"></path>
                </svg>
                <span id="busy-label">Preparing…</span>
            </div>

            <!-- Progress -->
            <div id="dl-progress" class="hidden mt-3">
                <div class="w-full bg-gray-200 rounded">
                    <div id="dl-bar" class="h-2 rounded bg-indigo-600" style="width:0%"></div>
                </div>
                <div id="dl-label" class="text-xs text-slate-600 mt-1">0%</div>
            </div>

            <div id="viewer-viewport" class="mt-3 p-2">
                <div id="pdf-render-area" class="rounded-t-lg">
                    <canvas id="pdf-canvas-1"></canvas>
                    <canvas id="pdf-canvas-2"></canvas>
                </div>
                <div id="pdf-nav" class="rounded-b-lg">
                    <div class="flex gap-2">
                        <button id="prev-page" class="bg-gray-300 text-gray-900 font-semibold py-2 px-4 rounded">&lt;
                            Previous</button>
                        <button id="next-page" class="bg-gray-300 text-gray-900 font-semibold py-2 px-4 rounded">Next
                            &gt;</button>
                    </div>
                    <span id="page-num-display" class="text-slate-700 font-medium"></span>
                </div>
            </div>
        </section>
    </main>

    <site-footer></site-footer>

    <script>
        /***** CONFIG *****/
        const APPS_SCRIPT_BASE = 'https://script.google.com/macros/s/AKfycbywvXtg8VoyvsckVNRutsQwPV8_dufWUxhvTTlW3wtxFOP6FJ5vdrCrwE7bdftKj5a2mg/exec';
        const FOLDER_ID = '1fxVRg5zDlf-Zre6uy8ac48C3ILHtaPfF';
        const VERSION = 'v7';

        /* ---- State & refs ---- */
        let pdfDoc = null;
        let currentPage = 1;
        let twoPageMode = true;   // auto (1 or 2 pages based on width)
        let pdfjsWorkerSet = false;

        const $ = (id) => document.getElementById(id);
        const canvas1 = () => $('pdf-canvas-1');
        const canvas2 = () => $('pdf-canvas-2');

        /* ---- UI helpers ---- */
        function setStatus(msg) { const el = $('list-status'); if (el) el.textContent = msg; }
        function setLoading(msg) { const el = $('loading-message'); if (el) el.textContent = msg; }
        function showBusy(show, label) {
            const box = $('busy'), txt = $('busy-label');
            if (!box) return;
            if (typeof label === 'string' && txt) txt.textContent = label;
            box.classList.toggle('hidden', !show);
        }
        function showProgress(show) { const box = $('dl-progress'); if (box) box.classList.toggle('hidden', !show); }
        function setProgress(pct, text) {
            const bar = $('dl-bar'), lbl = $('dl-label');
            if (bar) bar.style.width = Math.max(0, Math.min(100, pct)) + '%';
            if (lbl) lbl.textContent = text ?? (Math.round(pct) + '%');
        }
        function setModeFromViewport() {
            twoPageMode = !window.matchMedia('(max-width: 768px)').matches;
            canvas2().style.display = twoPageMode ? 'block' : 'none';
        }

        /* ---- Networking ---- */
        async function fetchList() {
            const url = `${APPS_SCRIPT_BASE}?mode=list&folderId=${encodeURIComponent(FOLDER_ID)}&v=${VERSION}`;
            const res = await fetch(url, { cache: 'no-store' });
            const text = await res.text();
            if (!res.ok) { setStatus(`HTTP ${res.status}: ${text.slice(0, 200)}`); throw new Error(`HTTP ${res.status}`); }
            const data = JSON.parse(text);
            if (data?.error) { setStatus(`Script error: ${data.error}`); throw new Error(data.error); }
            return data;
        }

        function b64ToBytes(b64) {
            b64 = (b64 || "").replace(/[\r\n\s]+/g, "").replace(/-/g, "+").replace(/_/g, "/");
            while (b64.length % 4 !== 0) b64 += "=";
            const bin = atob(b64);
            const out = new Uint8Array(bin.length);
            for (let i = 0; i < bin.length; i++) out[i] = bin.charCodeAt(i);
            return out;
        }

        async function fetchPdfBytes(fileId) {
            const url = `${APPS_SCRIPT_BASE}?mode=fileB64&fileId=${encodeURIComponent(fileId)}&v=${VERSION}`;
            const res = await fetch(url, { cache: "no-store" });
            const text = await res.text();
            if (!res.ok) throw new Error(`HTTP ${res.status}: ${text.slice(0, 200)}`);

            const head = text.trim().slice(0, 120);
            if (head.startsWith("ERROR") || head.startsWith("<") || head.startsWith("{")) {
                throw new Error("Server did not return base64. First 120 chars:\n" + head);
            }
            return b64ToBytes(text);
        }


        /* ---- High-DPI canvas rendering ---- */
        async function renderPageToCanvas(page, canvas, viewport) {
            // Use real DPR (respects desktop zoom) but cap a bit for perf
            const dprExact = window.devicePixelRatio || 1;
            const dpr = Math.min(dprExact, 2);

            const ctx = canvas.getContext('2d', { alpha: false });

            // Backing store in physical pixels (rounded to avoid fractional mismatch)
            const bw = Math.round(viewport.width * dpr);
            const bh = Math.round(viewport.height * dpr);
            canvas.width = bw;
            canvas.height = bh;

            // CSS size derived from backing size so bw === cssW * dpr exactly
            const cssW = bw / dpr;
            const cssH = bh / dpr;
            canvas.style.width = cssW + 'px';
            canvas.style.height = cssH + 'px';

            // Render with DPR transform (keeps vectors/text sharp)
            await page.render({
                canvasContext: ctx,
                viewport,
                transform: [dpr, 0, 0, dpr, 0, 0]
            }).promise;
        }


        /* ---- Rendering (two-page spread or single) ---- */
        async function loadAndOpen(fileId) {
            setLoading('Loading PDF...'); showBusy(true, 'Preparing…');
            const { pdfjsLib } = window;
            if (!pdfjsLib) { setStatus('PDF.js not loaded.'); showBusy(false); return; }
            if (!pdfjsWorkerSet) {
                pdfjsLib.GlobalWorkerOptions.workerSrc =
                    'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
                try { pdfjsLib.setVerbosity?.(pdfjsLib.VerbosityLevel.ERROR); } catch { }
                pdfjsWorkerSet = true;
            }

            let data;
            try { data = await fetchPdfBytes(fileId); }
            catch (e) { showBusy(false); setStatus('Download error: ' + e.message); return; }



            showBusy(true, 'Processing…');
            try { pdfDoc = await pdfjsLib.getDocument({ data }).promise; }
            catch (e) { showBusy(false); setStatus('PDF parse error: ' + e.message); return; }

            $('loading-message').style.display = 'none';
            currentPage = 1;
            showBusy(true, 'Rendering…');
            await renderPages(currentPage);
            updateNavButtons();
            showBusy(false);
        }

        async function renderPages(startPage) {
            if (!pdfDoc) return;
            setModeFromViewport();

            startPage = Math.max(1, Math.min(startPage, pdfDoc.numPages));

            const renderArea = $('pdf-render-area');
            const style = window.getComputedStyle(renderArea);
            const paddingX = parseFloat(style.paddingLeft) + parseFloat(style.paddingRight);
            const gap = parseFloat(style.gap) || 0;
            let availableWidth = renderArea.clientWidth - paddingX;

            const page1 = await pdfDoc.getPage(startPage);
            let totalPdfWidth = page1.getViewport({ scale: 1 }).width;

            let page2 = null, page2Num = null;
            if (twoPageMode) {
                page2Num = startPage + 1;
                if (page2Num <= pdfDoc.numPages) {
                    availableWidth -= gap;
                    page2 = await pdfDoc.getPage(page2Num);
                    totalPdfWidth += page2.getViewport({ scale: 1 }).width;
                }
            }

            const scale = availableWidth / totalPdfWidth;

            const vp1 = page1.getViewport({ scale });
            const c1 = canvas1();
            await renderPageToCanvas(page1, c1, vp1);
            c1.style.display = 'block';

            if (twoPageMode && page2) {
                const vp2 = page2.getViewport({ scale });
                const c2 = canvas2();
                await renderPageToCanvas(page2, c2, vp2);
                c2.style.display = 'block';
                $('page-num-display').textContent = `Pages ${startPage}–${page2Num} of ${pdfDoc.numPages}`;
            } else {
                canvas2().style.display = 'none';
                $('page-num-display').textContent = `Page ${startPage} of ${pdfDoc.numPages}`;
            }

            currentPage = startPage;
        }

        function updateNavButtons() {
            const prevDisabled = currentPage <= 1;
            const nextDisabled = twoPageMode
                ? (currentPage + 1 >= pdfDoc.numPages)
                : (currentPage >= pdfDoc.numPages);
            $('prev-page').disabled = prevDisabled;
            $('next-page').disabled = nextDisabled;
        }

        /* ---- Init & events ---- */
        function populateSelect(items) {
            const sel = $('pdf-select'); sel.innerHTML = '';
            items.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }));
            items.forEach(it => {
                const opt = document.createElement('option');
                opt.value = it.id; opt.textContent = it.display || it.name.replace(/\.pdf$/i, '');
                sel.appendChild(opt);
            });
        }

        async function initHSK() {
            setModeFromViewport();

            // Recompute 1–2 page layout on resize
            window.addEventListener('resize', async () => {
                const oldTwo = twoPageMode;
                setModeFromViewport();
                if (!pdfDoc) return;
                if (twoPageMode && currentPage % 2 === 0) currentPage -= 1; // left page on spread
                if (oldTwo !== twoPageMode) {
                    await renderPages(currentPage); updateNavButtons();
                } else {
                    await renderPages(currentPage); updateNavButtons();
                }
            });

            setStatus('Loading materials...');
            try {
                const list = await fetchList();
                if (!list.length) { setStatus('No PDFs found.'); return; }
                populateSelect(list);
                setStatus(`${list.length} materials found.`);
                $('pdf-select').addEventListener('change', (e) => loadAndOpen(e.target.value));
                await loadAndOpen(list[0].id);
            } catch (err) {
                setStatus(`Failed: ${err.message}`);
            }

            $('prev-page').addEventListener('click', async () => {
                if (!pdfDoc) return;
                const delta = twoPageMode ? 2 : 1;
                const target = currentPage - delta;
                if (target >= 1) { await renderPages(target); updateNavButtons(); }
            });
            $('next-page').addEventListener('click', async () => {
                if (!pdfDoc) return;
                const delta = twoPageMode ? 2 : 1;
                const target = currentPage + delta;
                if (target <= pdfDoc.numPages) { await renderPages(target); updateNavButtons(); }
            });
            $('goto-btn').addEventListener('click', async () => {
                if (!pdfDoc) return;
                const val = parseInt($('goto-input').value, 10);
                if (isNaN(val)) return;
                let target = Math.max(1, Math.min(val, pdfDoc.numPages));
                if (twoPageMode && target % 2 === 0) target -= 1;
                await renderPages(target); updateNavButtons();
            });
        }

        // Load PDF.js then init
        (function loadPdfJs() {
            const s = document.createElement('script');
            s.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js';
            s.onload = initHSK;
            s.onerror = () => setStatus('Failed to load PDF.js');
            document.head.appendChild(s);
        })();
    </script>
</body>

</html>